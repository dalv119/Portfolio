# Витрина RFM

## 1.1. Выясните требования к целевой витрине.

Постановка задачи выглядит достаточно абстрактно - постройте витрину. Первым делом вам необходимо выяснить у заказчика детали. Запросите недостающую информацию у заказчика в чате.

Зафиксируйте выясненные требования. Составьте документацию готовящейся витрины на основе заданных вами вопросов, добавив все необходимые детали.

-----------
Что сделать: необходимо создать витрину данных для RFM-классификации пользователей приложения

Зачем: подготовить данные для компании, которая разрабатывает приложение по доставке еды. Им нужно построить модель для сегментации клиентов и анализира их лояльности: как часто, на какие суммы и когда в последний раз тот или иной клиент покупал что-то. На основе этого выбирают клиентские категории, на которые стоит направить маркетинговые усилия

1. Наименование - dm_rfm_segments
2. Описание - витрина для RFM-классификации. Для анализа нужно отобрать только успешно выполненные заказы (статус типа Closed)
3. Глубина данных - с начала 2022 года
4. Расположение - база данных analysis
5. Кому доступна: всем
6. Структура витрины: 
    - user_id - идентификатор клиента;
    - recency - сколько времени прошло с момента последнего заказа (число от 1 до 5)  Распределите клиентов по шкале от одного до пяти, где значение 1 получат те, кто либо вообще не делал заказов, либо делал их очень давно, а 5 — те, кто заказывал относительно недавно
    - frequency - количество заказов (число от 1 до 5) Распределите клиентов по шкале от одного до пяти, где значение 1 получат клиенты с наименьшим количеством заказов, а 5 — с наибольшим
    - monetary_value - сумма затрат клиента (число от 1 до 5) Распределите клиентов по шкале от одного до пяти, где значение 1 получат клиенты с наименьшей суммой, а 5 — с наибольшей
7. Источники данных - база данных production
8. Заказчик данных - компания, которая разрабатывает приложение по доставке еды. 
9. Обновления данных - не требуется



## 1.2. Изучите структуру исходных данных.

Полключитесь к базе данных и изучите структуру таблиц.

Если появились вопросы по устройству источника, задайте их в чате.

Зафиксируйте, какие поля вы будете использовать для расчета витрины.

-----------

1. Существуют ли источники и есть ли к ним доступ: да
   
2. Достаточно ли полей в источниках для расчёта необходимых метрик: да
   
* - поля учавствующие в расчете

analysis.users
*   id int4 NOT NULL,
	"name" varchar(2048) NULL,
	login varchar(2048) NOT NULL,
	CONSTRAINT users_pkey PRIMARY KEY (id)
analysis.orders
*   order_id int4 NOT NULL,
*	order_ts timestamp NOT NULL,
*	user_id int4 NOT NULL,
	bonus_payment numeric(19, 5) NOT NULL DEFAULT 0,
*	payment numeric(19, 5) NOT NULL DEFAULT 0,
	"cost" numeric(19, 5) NOT NULL DEFAULT 0,
	bonus_grant numeric(19, 5) NOT NULL DEFAULT 0,
*	status int4 NOT NULL,
	CONSTRAINT orders_check CHECK ((cost = (payment + bonus_payment))),
	CONSTRAINT orders_pkey PRIMARY KEY (order_id)
analysis.orderstatuses
*   id int4 NOT NULL,
*	"key" varchar(255) NOT NULL,
	CONSTRAINT orderstatuses_pkey PRIMARY KEY (id)



## 1.3. Проанализируйте качество данных

Изучите качество входных данных. Опишите, насколько качественные данные хранятся в источнике. Так же укажите, какие инструменты обеспечения качества данных были использованы в таблицах в схеме production.

-----------

1. Дубли в данных: 
   Проверка показала, что в таблицах production.order, production.orderstatuses, production.users дублей в ключевых полях нет. Для всех id создан уникальный индекс: это гарантирует, что дублей быть не может
2. Пропущенные значения в важных полях:
   в таблицах нет пропусков и значений null
3. Некорректные типы данных:
   не замечены
4. Неверные форматы записей:
   не встречались
   


## 1.4. Подготовьте витрину данных

Теперь, когда требования понятны, а исходные данные изучены, можно приступить к реализации.

### 1.4.1. Сделайте VIEW для таблиц из базы production.**

Вас просят при расчете витрины обращаться только к объектам из схемы analysis. Чтобы не дублировать данные (данные находятся в этой же базе), вы решаете сделать view. Таким образом, View будут находиться в схеме analysis и вычитывать данные из схемы production. 

Напишите SQL-запросы для создания пяти VIEW (по одному на каждую таблицу) и выполните их. Для проверки предоставьте код создания VIEW.

```SQL
CREATE VIEW analysis.orderitems AS 
SELECT * FROM production.orderitems;

CREATE VIEW analysis.orders AS 
SELECT * FROM production.orders;

CREATE VIEW analysis.orderstatuses AS 
SELECT * FROM production.orderstatuses;

CREATE VIEW analysis.products AS 
SELECT * FROM production.products;

CREATE VIEW analysis.users AS 
SELECT * FROM production.users;

```

### 1.4.2. Напишите DDL-запрос для создания витрины.**

Далее вам необходимо создать витрину. Напишите CREATE TABLE запрос и выполните его на предоставленной базе данных в схеме analysis.

```SQL
CREATE TABLE analysis.dm_rfm_segments (
	user_id int not null primary key,
    recency int not null CHECK (recency between 1 and 5),
    frequency int not null CHECK (recency between 1 and 5),
    monetary_value int not null CHECK (recency between 1 and 5)
);

```

### 1.4.3. Напишите SQL запрос для заполнения витрины

Наконец, реализуйте расчет витрины на языке SQL и заполните таблицу, созданную в предыдущем пункте.

Для решения предоставьте код запроса.

```SQL

INSERT INTO analysis.dm_rfm_segments (
	user_id, 
	recency, 
	frequency, 
	monetary_value)
SELECT 
	r.user_id, 
	recency, 
	frequency, 
	monetary_value
FROM analysis.tmp_rfm_recency r
INNER JOIN analysis.tmp_rfm_frequency f 
on r.user_id = f.user_id 
INNER JOIN analysis.tmp_rfm_monetary_value mv 
on r.user_id = mv.user_id 
;


```



